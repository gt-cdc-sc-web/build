(function(NS,$){"use strict";var selectedIndex=-1,metrics=null,PRINT_MODE=$("html").is(".before-print"),EMPTY_MARK=PRINT_MODE?"":"&#8212;",MILISECOND=1,SECOND=MILISECOND*1e3,MINUTE=SECOND*60,HOUR=MINUTE*60,DAY=HOUR*24,WEEK=DAY*7,MONTH=WEEK*4.348214285714286,YEAR=MONTH*12,shortDateFormat={Years:"y",Year:"y",Months:"m",Month:"m",Weeks:"w",Week:"w",Days:"d",Day:"d",separator:" "};function isQuestionViewVisible(){return GC.App.getViewType()=="questions"}function renderQuestionView(container){var thepatient_id=window.sessionStorage.getItem("patient_id");thepatient_id=thepatient_id?thepatient_id:GC.chartSettings.defaultPatient;$.ajax({url:GC.chartSettings.serverBase+"/QuestionnaireResponse/?patient="+thepatient_id+"&_sort=_lastUpdated",dataType:"json",success:processQuestionnaires});function buildPanelContainer(){return $("<div></div>").addClass("container")}function buildPanelGroup(){return $("<div></div>").addClass("panel-group")}function processQuestionnaires(questionnairesResult){$(container).empty();var thequestions=$("<div></div>").addClass("thequestions");thequestions.attr("id","thequestions-div").attr("width","100%");$(container).append(thequestions);if(!questionnairesResult)return;if(questionnairesResult.data){questionnairesResult=questionnairesResult.data}var panelContainer=buildPanelContainer();var panelGroup=buildPanelGroup();thequestions.append(panelContainer);panelContainer.append(panelGroup);var questionnaireLink;var questionnaireResponse;if(questionnairesResult.total<1){questionnaireLink="/Questionnaire/"+GC.chartSettings.defaultQuestionnaire}else{for(var i=0;i<questionnairesResult.total;i++){questionnaireLink="/"+questionnairesResult.entry[i].resource.questionnaire.reference;questionnaireResponse=questionnairesResult.entry[i].resource;renderQuestionnaires(i+1,panelGroup,questionnaireLink,questionnaireResponse)}}renderQuestionnaires(undefined,panelGroup,questionnaireLink,undefined)}}function renderQuestionnaires(panelNumber,panelGroup,questionnaireLink,questionnaireResponse){$.ajax({url:GC.chartSettings.serverBase+questionnaireLink,dataType:"json",async:false,success:function(questionsResult){buildDom(panelNumber,panelGroup,questionsResult,questionnaireResponse)}});function buildDom(panelNumber,panelGroup,questionsResult,questionnaireResponse){if(!questionsResult)return;if(questionsResult.data){questionsResult=questionsResult.data}console.log(questionsResult);panelGroup.append(buildPanel(panelNumber,questionsResult,questionnaireResponse))}function buildPanel(panelNumber,questionsResult,questionnaireResponse){if(questionnaireResponse!==undefined){return buildQuestionnairePanel(panelNumber,questionsResult,questionnaireResponse)}else{return buildDefaultPanel(questionsResult)}}function buildQuestionnairePanel(panelNumber,questionsResult,questionnaireResponse){return $("<div></div>").addClass("panel").append($("<div></div>").addClass("panel-heading").append($("<div></div>").addClass("panel-title").append($("<a></a>").attr("data-toggle","collapse").attr("href","#collapse"+panelNumber).text(questionsResult.group.title+" - "+new Date(questionnaireResponse.meta.lastUpdated))))).append($("<div></div>").addClass("panel-collapse collapse").attr("id","collapse"+panelNumber).append(generateQuestionContainer(questionsResult,questionnaireResponse,true)))}function buildDefaultPanel(questionsResult){return $("<div></div>").addClass("panel panel-default").append($("<div></div>").addClass("panel-heading").append($("<div></div>").addClass("panel-title").append($("<a></a>").attr("data-toggle","collapse").attr("href","#collapse-default").text("Add New Questionnaire")))).append($("<div></div>").addClass("panel-collapse collapse").attr("id","collapse-default").append($("<div></div>").addClass("panel-body").append(generateQuestionContainer(questionsResult,undefined,false))))}function generateQuestionContainer(questionsResult,questionnaireResponse,disableControls){var id=questionsResult.id?questionsResult.id:"";var narrative=questionsResult.text?questionsResult.text.div:"";var questionType=questionsResult.resourceType?questionsResult.resourceType:"";var version=questionsResult.version?questionsResult.version:"";var qdate=questionsResult.date?questionsResult.date:"";var publisher=questionsResult.publisher?questionsResult.publisher:"";var llgroup=questionsResult.group;while(true){if(typeof llgroup!="undefined"&&llgroup.group){llgroup=llgroup.group[0];continue}break}var questionContainer=$("<div></div>").addClass("container").addClass("panel-body");var questiondom=$("<div></div>").addClass("container");for(var qind=0;qind<llgroup.question.length;qind++){var questiondata=llgroup.question[qind];var thequestion=questiondata.text?questiondata.text:"";var theoptions=[];for(var ind=0;questiondata.option&&ind<questiondata.option.length;ind++){theoptions.push([questiondata.option[ind].code?questiondata.option[ind].code:"",questiondata.option[ind].display?questiondata.option[ind].display:""])}var optdom=$("<div></div>").addClass("btn-group btn-group-justified").attr("data-toggle","buttons");for(var optind=0;optind<theoptions.length;optind++){var label=$("<label></label>");label.addClass("btn btn-default btn-responsive questions-theoptions waves-effect waves-light").attr("id","questions-theoptions-"+qind+"-"+optind);if(disableControls){label.click(function(){return false})}var input=$("<input />");input.attr("type","radio").attr("id","qopt-"+qind+"-"+optind).attr("name","qopt-"+qind).attr("value",theoptions[optind][0]);if(questionnaireResponse!==undefined&&questionnaireResponse.group.question[qind].answer[0].valueInteger==optind+1){label.addClass("active");input.prop("checked")}label.append(input);label.append(theoptions[optind][1]);optdom.append(label)}questiondom.append($("<div></div>").addClass("row well").append($("<div></div>").addClass("questions-thequestion col-sm-3 bb").attr("id","questions-thequestion-"+qind).html(thequestion)).append($("<div></div>").addClass("col-sm-9 bb").append(optdom)))}questionContainer.append(questiondom);return questionContainer}}NS.QuestionView={render:function(){renderQuestionView("#view-questions")}};$(function(){if(!PRINT_MODE){$("html").bind("set:viewType set:language",function(e){if(isQuestionViewVisible()){renderQuestionView("#view-questions")}});GC.Preferences.bind("set:metrics set:nicu set:currentColorPreset",function(e){if(isQuestionViewVisible()){renderQuestionView("#view-questions")}});GC.Preferences.bind("set",function(e){if(e.data.path=="roundPrecision.velocity.nicu"||e.data.path=="roundPrecision.velocity.std"){if(isQuestionViewVisible()){renderQuestionView("#view-questions")}}});GC.Preferences.bind("set:timeFormat",function(e){renderQuestionView("#view-questions")})}})})(GC,jQuery);